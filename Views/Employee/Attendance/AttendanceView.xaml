<UserControl x:Class="HillsCafeManagement.Views.Employee.Attendance.AttendanceView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:models="clr-namespace:HillsCafeManagement.Models">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <!-- Enum sources for combo boxes -->
        <ObjectDataProvider x:Key="LeaveTypeValues" MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:LeaveType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="LeaveStatusValues" MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:LeaveStatus"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
    </UserControl.Resources>

    <Border Padding="20" Background="Transparent">
        <TabControl>
            <!-- ATTENDANCE TAB -->
            <TabItem Header="Attendance">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="49*"/>
                        <ColumnDefinition Width="187*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>  <!-- 0 Title + Employee header -->
                        <RowDefinition Height="Auto"/>  <!-- 1 Manual toggle -->
                        <RowDefinition Height="Auto"/>  <!-- 2 Manual inputs -->
                        <RowDefinition Height="Auto"/>  <!-- 3 Actions -->
                        <RowDefinition Height="Auto"/>  <!-- 4 Tip + feedback -->
                        <RowDefinition Height="Auto"/>  <!-- 5 Filters -->
                        <RowDefinition Height="Auto"/>  <!-- 6 Progress -->
                        <RowDefinition Height="*"/>     <!-- 7 Records table -->
                    </Grid.RowDefinitions>

                    <!-- Title + Employee header -->
                    <Grid Grid.Row="0" Grid.ColumnSpan="2" Margin="0 0 0 12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   Text="⏱ Clock In/Out Panel"
                                   FontSize="20"
                                   FontWeight="Bold"
                                   Foreground="White"/>

                        <!-- Employee (Name + User ID) -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" >
                            <TextBlock Text="👤 " FontSize="16" Margin="0,0,4,0"/>
                            <TextBlock Text="{Binding EmployeeDisplay}"
                                       FontSize="14"
                                       FontWeight="SemiBold"
                                       Foreground="White"
                                       ToolTip="{Binding EmployeeDisplay}"/>
                        </StackPanel>
                    </Grid>

                    <!-- Manual toggle -->
                    <CheckBox Grid.Row="1"
                              Content="Manual Date and Time"
                              IsChecked="{Binding IsManualMode, Mode=TwoWay}"
                              Foreground="White"
                              Margin="0 0 0 10" Grid.ColumnSpan="2"/>

                    <!-- Manual inputs -->
                    <Grid Grid.Row="2" IsEnabled="{Binding IsManualMode}" Margin="0 0 0 12" Grid.ColumnSpan="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="140"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" VerticalAlignment="Center" Margin="0 0 8 0" Foreground="White" Text="Date"/>
                        <DatePicker Grid.Column="1" SelectedDate="{Binding ManualDate, Mode=TwoWay}" Width="175"/>

                        <TextBlock Grid.Column="3" VerticalAlignment="Center" Margin="0 0 8 0" Foreground="White" Text="Time"/>
                        <TextBox Grid.Column="4"
                                 Width="130"
                                 MaxLength="8"
                                 ToolTip="Enter time as HH:mm or HH:mm:ss"
                                 Text="{Binding ManualTimeText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    </Grid>

                    <!-- Clock actions -->
                    <StackPanel Grid.Row="3" Orientation="Horizontal" Grid.ColumnSpan="2" Margin="0,0,0,62" Grid.RowSpan="2">
                        <Button Content="Clock In" Width="120" Margin="0 0 8 0" Command="{Binding ClockInCommand}"/>
                        <Button Content="Clock Out" Width="120" Command="{Binding ClockOutCommand}"/>
                    </StackPanel>

                    <!-- Tips + feedback -->
                    <StackPanel Grid.Row="4" Margin="0,10,0,12" Grid.ColumnSpan="2">
                        <TextBlock Foreground="White" Opacity="0.8"
                                   Text="Tip: Leave Manual Date and Time unchecked to use the current time automatically."/>
                        <TextBlock Text="{Binding LastMessage}"
                                   Margin="0 8 0 0"
                                   Foreground="LightGreen"
                                   FontWeight="SemiBold"
                                   TextWrapping="Wrap"/>
                    </StackPanel>

                    <!-- Filters + actions -->
                    <Grid Grid.Row="5" Margin="0 0 0 10" Grid.ColumnSpan="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="160"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="160"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="White" Margin="0 0 8 0" Text="Filter:"/>
                        <DatePicker Grid.Column="1" SelectedDate="{Binding FilterFromDate, Mode=TwoWay}" Width="150"/>
                        <TextBlock Grid.Column="2"/>

                        <TextBlock Grid.Column="3" VerticalAlignment="Center" Foreground="White" Margin="0 0 8 0" Text="to"/>
                        <DatePicker Grid.Column="4" SelectedDate="{Binding FilterToDate, Mode=TwoWay}" Width="150"/>

                        <TextBlock Grid.Column="5"/>

                        <Button Grid.Column="6" Content="Apply" Width="100" Command="{Binding ApplyFilterCommand}"/>
                        <Button Grid.Column="7" Content="Reset" Width="100" Margin="8 0 0 0" Command="{Binding ResetFilterCommand}"/>

                        <TextBlock Grid.Column="8"/>

                        <Button Grid.Column="9" Content="Refresh" Width="100" Command="{Binding RefreshListCommand}"/>
                    </Grid>

                    <!-- Progress -->
                    <ProgressBar Grid.Row="6"
                                 Height="4"
                                 IsIndeterminate="True"
                                 Visibility="{Binding IsBusyAttendance, Converter={StaticResource BoolToVis}}"
                                 Margin="0 0 0 8" Grid.ColumnSpan="2"/>

                    <!-- Records table -->
                    <DataGrid Grid.Row="7"
                              ItemsSource="{Binding Attendances}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              CanUserAddRows="False"
                              EnableRowVirtualization="True"
                              RowHeaderWidth="0"
                              HeadersVisibility="Column"
                              Margin="0 8 0 0" Grid.ColumnSpan="2">
                        <DataGrid.Columns>

                            <!-- NEW: Employee column (read-only, shows Name + User ID) -->
                            <DataGridTextColumn Header="Employee"
                                                Binding="{Binding EmployeeDisplay}"
                                                IsReadOnly="True"
                                                Width="2*"/>

                            <DataGridTextColumn Header="Date"
                                                Binding="{Binding Date, StringFormat={}{0:yyyy-MM-dd}}"
                                                Width="*" />
                            <DataGridTextColumn Header="Time In"
                                                Binding="{Binding TimeIn, StringFormat={}{0:hh\\:mm\\:ss}, TargetNullValue=—}"
                                                Width="*" />
                            <DataGridTextColumn Header="Time Out"
                                                Binding="{Binding TimeOut, StringFormat={}{0:hh\\:mm\\:ss}, TargetNullValue=—}"
                                                Width="*" />

                            <!-- CHANGED: bind to computed DisplayStatus (No Record / Day Off / Present / etc.) -->
                            <DataGridTextColumn Header="Status"
                                                Binding="{Binding DisplayStatus}"
                                                Width="*" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <!-- LEAVE REQUESTS TAB (unchanged) -->
            <TabItem Header="Leave Requests">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="360"/>
                        <!-- Form -->
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                        <!-- List -->
                    </Grid.ColumnDefinitions>

                    <!-- LEFT: Form -->
                    <GroupBox Header="Request Form" Grid.Column="0" Padding="12" Margin="0 0 0 8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="120"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Type -->
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Type" VerticalAlignment="Center" Margin="0 0 8 6" Foreground="White"/>
                            <ComboBox Grid.Row="0" Grid.Column="1" Margin="0 0 0 6"
                                      ItemsSource="{Binding Source={StaticResource LeaveTypeValues}}"
                                      SelectedItem="{Binding LeaveType, Mode=TwoWay}"/>

                            <!-- Reason -->
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Reason" VerticalAlignment="Top" Margin="0 0 8 6" Foreground="White"/>
                            <TextBox Grid.Row="1" Grid.Column="1" Margin="0 0 0 6"
                                     Text="{Binding LeaveReason, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     AcceptsReturn="True" MinHeight="60" TextWrapping="Wrap"/>

                            <!-- Date From -->
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="From" VerticalAlignment="Center" Margin="0 0 8 6" Foreground="White"/>
                            <DatePicker Grid.Row="2" Grid.Column="1" Margin="0 0 0 6"
                                        SelectedDate="{Binding LeaveDateFrom, Mode=TwoWay}"/>

                            <!-- Date To -->
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="To" VerticalAlignment="Center" Margin="0 0 8 6" Foreground="White"/>
                            <DatePicker Grid.Row="3" Grid.Column="1" Margin="0 0 0 6"
                                        SelectedDate="{Binding LeaveDateTo, Mode=TwoWay}"/>

                            <!-- Half Day -->
                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Half Day" VerticalAlignment="Center" Margin="0 0 8 6" Foreground="White"/>
                            <CheckBox Grid.Row="4" Grid.Column="1" Margin="0 0 0 6"
                                      IsChecked="{Binding LeaveHalfDay, Mode=TwoWay}"/>

                            <!-- Duration (read-only) -->
                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Duration" VerticalAlignment="Center" Margin="0 0 8 6" Foreground="White"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" Margin="0 0 0 6"
                                       Text="{Binding LeaveDurationDays}" Foreground="LightGreen" FontWeight="SemiBold"/>

                            <!-- Buttons -->
                            <StackPanel Grid.Row="6" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0 6 0 0">
                                <Button Content="New" Width="80" Margin="0 0 6 0" Command="{Binding NewLeaveFormCommand}"/>
                                <Button Content="Submit" Width="90" Margin="0 0 6 0" Command="{Binding SubmitLeaveRequestCommand}"/>
                                <Button Content="Update" Width="90" Margin="0 0 6 0" Command="{Binding UpdateLeaveRequestCommand}"/>
                                <Button Content="Cancel Request" Width="120" Command="{Binding CancelLeaveRequestCommand}"/>
                            </StackPanel>

                            <!-- Feedback -->
                            <TextBlock Grid.Row="7" Grid.ColumnSpan="2" Margin="0 10 0 0"
                                       Text="{Binding LastMessage}" Foreground="LightGreen" FontWeight="SemiBold" TextWrapping="Wrap"/>
                        </Grid>
                    </GroupBox>

                    <!-- Spacer -->
                    <Grid Grid.Column="1"/>

                    <!-- RIGHT: Filter + List -->
                    <Grid Grid.Column="2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>  <!-- Filters -->
                            <RowDefinition Height="Auto"/>  <!-- Progress -->
                            <RowDefinition Height="*"/>     <!-- Table -->
                        </Grid.RowDefinitions>

                        <!-- Filters -->
                        <Grid Grid.Row="0" Margin="0 0 0 10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="White" Margin="0 0 8 0" Text="From"/>
                            <DatePicker Grid.Column="1" SelectedDate="{Binding LeaveFilterFrom, Mode=TwoWay}"/>

                            <TextBlock Grid.Column="2"/>

                            <TextBlock Grid.Column="3" VerticalAlignment="Center" Foreground="White" Margin="0 0 8 0" Text="To"/>
                            <DatePicker Grid.Column="4" SelectedDate="{Binding LeaveFilterTo, Mode=TwoWay}"/>

                            <TextBlock Grid.Column="5"/>

                            <TextBlock Grid.Column="6" VerticalAlignment="Center" Foreground="White" Margin="0 0 8 0" Text="Status"/>
                            <ComboBox Grid.Column="7"
                                      ItemsSource="{Binding Source={StaticResource LeaveStatusValues}}"
                                      SelectedItem="{Binding LeaveFilterStatus, Mode=TwoWay}"/>

                            <TextBlock Grid.Column="8"/>

                            <Button Grid.Column="9" Content="Apply" Width="90" Command="{Binding ApplyLeaveFilterCommand}" />
                            <Button Grid.Column="10" Content="Reset" Width="90" Margin="6 0 0 0" Command="{Binding ResetLeaveFilterCommand}" />
                            <Button Grid.Column="11" Content="Refresh" Width="90" Margin="6 0 0 0" Command="{Binding LoadLeaveListCommand}" />
                        </Grid>

                        <!-- Progress -->
                        <ProgressBar Grid.Row="1" Height="4" IsIndeterminate="True"
                                     Visibility="{Binding IsBusyLeave, Converter={StaticResource BoolToVis}}"
                                     Margin="0 0 0 8"/>

                        <!-- Table -->
                        <DataGrid Grid.Row="2"
                                  ItemsSource="{Binding LeaveRequests}"
                                  SelectedItem="{Binding SelectedLeave, Mode=TwoWay}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  IsReadOnly="True"
                                  EnableRowVirtualization="True"
                                  RowHeaderWidth="0"
                                  HeadersVisibility="Column">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="From" Binding="{Binding DateFrom, StringFormat={}{0:yyyy-MM-dd}}" Width="*" />
                                <DataGridTextColumn Header="To" Binding="{Binding DateTo, StringFormat={}{0:yyyy-MM-dd}}" Width="*" />
                                <DataGridTextColumn Header="Half" Binding="{Binding HalfDay}" Width="60" />
                                <DataGridTextColumn Header="Type" Binding="{Binding LeaveType}" Width="*" />
                                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*" />
                                <DataGridTextColumn Header="Reason" Binding="{Binding Reason}" Width="2*" />
                                <DataGridTextColumn Header="Approved At" Binding="{Binding ApprovedAt, StringFormat={}{0:yyyy-MM-dd HH:mm}, TargetNullValue=—}" Width="*" />
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Load selected into form -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0 8 0 0">
                            <Button Content="Load Selected to Form" Command="{Binding EditSelectedLeaveCommand}" />
                        </StackPanel>
                    </Grid>
                </Grid>
            </TabItem>
        </TabControl>
    </Border>
</UserControl>
